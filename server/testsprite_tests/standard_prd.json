{
  "meta": {
    "project": "SokoPrice API",
    "date": "2026-02-21",
    "prepared_by": "Generated by TestSprite"
  },
  "product_overview": "SokoPrice is a backend API platform that enables Kenyan farmers to check and submit crop prices via USSD/SMS and provides web dashboards for admins, buyers and NGOs with analytics and confidence-scored market prices.",
  "core_goals": [
    "Enable basic-phone access to market prices via USSD and SMS (English & Swahili).",
    "Collect, store and surface crowd-sourced crop prices with confidence scoring and admin moderation.",
    "Provide authenticated dashboards and analytics for admins, buyers and NGOs.",
    "Expose public market and crop data for consumers and integrations.",
    "Maintain secure role-based access (JWT) and robust health/operational endpoints."
  ],
  "features": [
    {
      "name": "Authentication API",
      "description": "User registration, login and profile retrieval using JWT; supports role-based access (Farmer, Admin, Buyer).",
      "user_flows": [
        "POST /api/auth/register with {name, email, password} -> Receive 201 with {token, user: {id, name, email, role, language}} -> POST /api/auth/login with {email, password} -> Receive 200 with JWT token and user info -> GET /api/auth/me with Authorization: Bearer <token> -> Receive 200 with user profile including phoneNumber and role",
        "POST /api/auth/register with existing email -> Receive 400 with validation error (email already exists)",
        "POST /api/auth/login with missing email or password -> Receive 400 missing credentials error",
        "POST /api/auth/login with wrong password -> Receive 401 invalid credentials"
      ]
    },
    {
      "name": "USSD Gateway API",
      "description": "Handles incoming USSD sessions (start menus, check prices, submit prices, change language) and returns CON/END text responses optimized for telecom session limits.",
      "user_flows": [
        "POST /api/ussd with {sessionId, serviceCode, phoneNumber, text:'' (start)} -> Receive 200 text/plain response beginning with CON presenting main menu (1. Check market prices, 2. Submit today's price, 3. Language)",
        "POST /api/ussd with {sessionId, serviceCode, phoneNumber, text:'1'} -> Receive 200 CON 'Select crop: 1.Maize 2.Beans 3.Rice 4.Potatoes'",
        "POST /api/ussd with {sessionId, serviceCode, phoneNumber, text:'1*1'} -> Receive 200 CON 'Select market: 1.Wakulima 2.Eldoret' -> POST /api/ussd with {sessionId, serviceCode, phoneNumber, text:'1*1*1'} -> Receive 200 END 'Maize â€” Wakulima\\nKSh 3,500 per 90kg\\nConfidence: High\\n1. Get SMS copy' (happy path: check prices)",
        "POST /api/ussd with {sessionId, serviceCode, phoneNumber, text:'2'} -> Receive 200 CON 'Select crop for submission' -> POST /api/ussd with {sessionId, serviceCode, phoneNumber, text:'2*1'} -> Receive 200 CON 'Select market' -> POST /api/ussd with {sessionId, serviceCode, phoneNumber, text:'2*1*1*3500'} -> Receive 200 END 'Thank you, price submitted (pending approval)' (happy path: submit price)",
        "POST /api/ussd with malformed body (missing sessionId or phoneNumber) -> Receive 400 Bad Request (error flow)",
        "POST /api/ussd with overly long text exceeding session limits -> Receive 400 or END with error message indicating invalid input (error flow)"
      ]
    },
    {
      "name": "Prices API",
      "description": "Public listing and submission of crop market prices, plus admin approval/rejection; prices include confidence scoring and support filtering by crop/market/approval.",
      "user_flows": [
        "GET /api/prices?cropId=<cropId>&marketId=<marketId>&approved=true -> Receive 200 { prices: [...], total, page, pages } (happy path: filtered list)",
        "GET /api/prices with invalid query param value (non-UUID cropId) -> Receive 400 validation error (error flow)",
        "POST /api/prices with {cropId, marketId, price, sourceId, notes} -> Receive 201 with Price object (status: pending) (happy path: submit new price report)",
        "POST /api/prices with missing price field -> Receive 400 validation error (error flow)",
        "POST /api/auth/login with admin credentials -> Receive 200 with JWT token -> PATCH /api/prices/:id/approve with Authorization: Bearer <admin-token> -> Receive 200 with updated Price (status: approved) (happy path: admin approves pending price)",
        "PATCH /api/prices/:id/approve without Authorization header -> Receive 401 Unauthorized (error flow)",
        "POST /api/auth/login with non-admin user -> Receive 200 with JWT token -> PATCH /api/prices/:id/approve with non-admin token -> Receive 403 Forbidden (error flow)",
        "POST /api/auth/login with admin credentials -> Receive 200 with JWT token -> PATCH /api/prices/:id/reject with Authorization: Bearer <admin-token> -> Receive 200 { message: 'Price rejected and removed' } (happy path: admin rejects price)"
      ]
    },
    {
      "name": "Analytics API",
      "description": "Provides dashboard statistics, price trends and market comparisons for authenticated dashboards and a public dashboard alias.",
      "user_flows": [
        "POST /api/auth/login with admin credentials -> Receive 200 with JWT token -> GET /api/analytics/overview with Authorization: Bearer <token> -> Receive 200 { totalUsers, activeMarkets, pricesToday, pendingApprovals, totalCrops, totalSources } (happy path: authenticated overview)",
        "GET /api/analytics/dashboard -> Receive 200 { totalUsers, activeMarkets, pricesToday, pendingApprovals, totalCrops, totalSources } (happy path: public alias)",
        "GET /api/analytics/overview without Authorization header -> Receive 401 Unauthorized (error flow)",
        "POST /api/auth/login with admin credentials -> Receive 200 with JWT token -> GET /api/analytics/trends?days=30&cropId=<cropId>&marketId=<marketId> with Authorization: Bearer <token> -> Receive 200 Array of { date, crop, market, avgPrice, minPrice, maxPrice, submissions } (happy path: trends)",
        "GET /api/analytics/compare?cropId=<missing> with Authorization: Bearer <token> -> Receive 400 validation error (error flow when required cropId missing)"
      ]
    },
    {
      "name": "Crop Management API",
      "description": "Public listing of crop types used by USSD and price submission flows.",
      "user_flows": [
        "GET /api/crops -> Receive 200 array of Crop objects (happy path: list available crops)",
        "GET /api/crops when database is unavailable -> Receive 500 Internal Server Error (error flow)"
      ]
    },
    {
      "name": "Market Management API",
      "description": "Public listing of markets used by USSD and price submission flows.",
      "user_flows": [
        "GET /api/markets -> Receive 200 array of Market objects (happy path: list available markets)",
        "GET /api/markets with malformed query or DB failure -> Receive 500 Internal Server Error (error flow)"
      ]
    },
    {
      "name": "Alerts API",
      "description": "Create SMS/alert subscriptions for users (authenticated); used by dashboards to notify users about price changes.",
      "user_flows": [
        "POST /api/auth/login with user credentials -> Receive 200 with JWT token -> POST /api/alerts with Authorization: Bearer <token> and {cropId, marketId, threshold, channel:'sms'} -> Receive 201 with Alert object (happy path: create alert)",
        "POST /api/alerts without Authorization header -> Receive 401 Unauthorized (error flow)",
        "POST /api/alerts with invalid threshold (non-number) -> Receive 400 Validation error (error flow)"
      ]
    },
    {
      "name": "Health Check",
      "description": "Simple operational endpoint to verify service health, version and timestamp.",
      "user_flows": [
        "GET /api/health -> Receive 200 { status: 'ok', service, version, timestamp } (happy path: service healthy)",
        "GET /api/health when dependent services down (e.g. MongoDB unreachable) -> Receive 503 Service Unavailable or 200 with degraded status (error/degraded flow)"
      ]
    }
  ],
  "code_summary": {
    "version": "2",
    "type": "backend",
    "tech_stack": [
      "TypeScript",
      "Express.js",
      "Node.js",
      "MongoDB",
      "Mongoose",
      "JWT (jsonwebtoken)",
      "bcryptjs"
    ],
    "features": [
      {
        "name": "Authentication API",
        "description": "User registration, login, and profile retrieval with JWT authentication",
        "files": [
          "src/controllers/authController.ts",
          "src/routes/authRoutes.ts",
          "src/middleware/auth.ts",
          "src/models/User.ts"
        ],
        "endpoints": [
          {
            "method": "POST",
            "path": "/api/auth/register",
            "description": "Register a new user account",
            "auth_required": false,
            "request_schema": {
              "body": {
                "name": "string",
                "email": "string",
                "password": "string"
              }
            },
            "response_schema": {
              "201": "{ token, user: { id, name, email, role, language } }",
              "400": "Validation error or email exists"
            }
          },
          {
            "method": "POST",
            "path": "/api/auth/login",
            "description": "Login with email and password to get JWT token",
            "auth_required": false,
            "request_schema": {
              "body": {
                "email": "string",
                "password": "string"
              }
            },
            "response_schema": {
              "200": "{ token, user: { id, name, email, role, language } }",
              "400": "Missing email or password",
              "401": "Invalid credentials"
            }
          },
          {
            "method": "GET",
            "path": "/api/auth/me",
            "description": "Get current authenticated user profile",
            "auth_required": true,
            "response_schema": {
              "200": "{ user: { id, name, email, role, language, phoneNumber } }"
            }
          }
        ],
        "depends_on": []
      },
      {
        "name": "USSD Gateway API",
        "description": "Handle incoming USSD sessions for farmers to check and submit crop prices",
        "files": [
          "src/controllers/ussdController.ts",
          "src/routes/ussdRoutes.ts"
        ],
        "endpoints": [
          {
            "method": "POST",
            "path": "/api/ussd",
            "description": "Process a USSD menu session (check prices, submit prices, change language)",
            "auth_required": false,
            "request_schema": {
              "body": {
                "sessionId": "string",
                "serviceCode": "string",
                "phoneNumber": "string",
                "text": "string"
              }
            },
            "response_schema": {
              "200": "text/plain response starting with CON or END"
            }
          }
        ],
        "depends_on": [
          "Crop Management API",
          "Market Management API"
        ]
      },
      {
        "name": "Prices API",
        "description": "CRUD operations for crop market prices with confidence scoring",
        "files": [
          "src/controllers/priceController.ts",
          "src/routes/priceRoutes.ts",
          "src/models/Price.ts",
          "src/services/confidenceService.ts"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/prices",
            "description": "List prices with optional filters (cropId, marketId, approved)",
            "auth_required": false,
            "response_schema": {
              "200": "{ prices: Price[], total, page, pages }"
            }
          },
          {
            "method": "GET",
            "path": "/api/prices/market",
            "description": "Public alias for listing all market prices",
            "auth_required": false,
            "response_schema": {
              "200": "{ prices: Price[], total, page, pages }"
            }
          },
          {
            "method": "POST",
            "path": "/api/prices",
            "description": "Submit a new price report",
            "auth_required": false,
            "request_schema": {
              "body": {
                "cropId": "string",
                "marketId": "string",
                "price": "number",
                "sourceId": "string",
                "notes": "string"
              }
            },
            "response_schema": {
              "201": "Price"
            }
          },
          {
            "method": "PATCH",
            "path": "/api/prices/:id/approve",
            "description": "Approve a pending price (Admin only)",
            "auth_required": true,
            "response_schema": {
              "200": "Price"
            }
          },
          {
            "method": "PATCH",
            "path": "/api/prices/:id/reject",
            "description": "Reject and remove a pending price (Admin only)",
            "auth_required": true,
            "response_schema": {
              "200": "{ message: 'Price rejected and removed' }"
            }
          }
        ],
        "depends_on": [
          "Authentication API"
        ]
      },
      {
        "name": "Analytics API",
        "description": "Dashboard statistics, price trends, and market comparisons",
        "files": [
          "src/controllers/analyticsController.ts",
          "src/routes/analyticsRoutes.ts"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/analytics/overview",
            "description": "Get overview statistics (total users, active markets, prices today, etc.)",
            "auth_required": true,
            "response_schema": {
              "200": "{ totalUsers, activeMarkets, pricesToday, pendingApprovals, totalCrops, totalSources }"
            }
          },
          {
            "method": "GET",
            "path": "/api/analytics/dashboard",
            "description": "Public alias for overview statistics",
            "auth_required": false,
            "response_schema": {
              "200": "{ totalUsers, activeMarkets, pricesToday, pendingApprovals, totalCrops, totalSources }"
            }
          },
          {
            "method": "GET",
            "path": "/api/analytics/trends",
            "description": "Get price trends over time with optional filters",
            "auth_required": true,
            "request_schema": {
              "query": {
                "days": "number",
                "cropId": "string",
                "marketId": "string"
              }
            },
            "response_schema": {
              "200": "Array of { date, crop, market, avgPrice, minPrice, maxPrice, submissions }"
            }
          },
          {
            "method": "GET",
            "path": "/api/analytics/compare",
            "description": "Compare prices across markets for a specific crop",
            "auth_required": true,
            "request_schema": {
              "query": {
                "cropId": "string (required)"
              }
            },
            "response_schema": {
              "200": "Array of { market, county, price, date, confidence }"
            }
          }
        ],
        "depends_on": [
          "Authentication API"
        ]
      },
      {
        "name": "Crop Management API",
        "description": "CRUD for crop types",
        "files": [
          "src/controllers/cropController.ts",
          "src/routes/cropRoutes.ts",
          "src/models/Crop.ts"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/crops",
            "description": "List all crops",
            "auth_required": false,
            "response_schema": {
              "200": "Crop[]"
            }
          }
        ],
        "depends_on": []
      },
      {
        "name": "Market Management API",
        "description": "CRUD for market locations",
        "files": [
          "src/controllers/marketController.ts",
          "src/routes/marketRoutes.ts",
          "src/models/Market.ts"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/markets",
            "description": "List all markets",
            "auth_required": false,
            "response_schema": {
              "200": "Market[]"
            }
          }
        ],
        "depends_on": []
      },
      {
        "name": "Health Check",
        "description": "Simple health check endpoint",
        "files": [
          "src/index.ts"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/health",
            "description": "Returns server health status",
            "auth_required": false,
            "response_schema": {
              "200": "{ status: 'ok', service, version, timestamp }"
            }
          }
        ],
        "depends_on": []
      }
    ],
    "known_limitations": [
      {
        "issue": "SMS service falls back to simulated mode without Africa's Talking credentials",
        "location": "src/services/smsService.ts",
        "impact": "SMS messages are logged to console instead of sent"
      },
      {
        "issue": "Admin credentials must be seeded before login tests work",
        "location": "src/seed.ts",
        "impact": "Tests requiring auth will fail if npm run seed has not been run"
      },
      {
        "issue": "Test admin user credentials for login",
        "location": ".env",
        "impact": "Use these credentials for all authenticated test endpoints: email=admin@sokoprice.co.ke password=Admin@123456"
      },
      {
        "issue": "Test buyer user credentials for login",
        "location": ".env",
        "impact": "Alternative user for testing: email=buyer@sokoprice.co.ke password=Buyer@123456"
      }
    ]
  }
}
